<!DOCTYPE html>
<html>
  <head>
    <title>Camera Test</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  </head>
  <body>
    <button id="picture-button">Take Picture</button>
    <h1 id="filename">&nbsp;</h1>
    <img id="picture" />
    <video id="video"></video>
    <script>
      $(document).ready(() => {
        navigator.mediaDevices.getUserMedia({ audio: false, video: { width: 9999, height: 9999, facingMode: 'environment' } })
          .then(function(stream) {
          const video = $("#video")[0];
          video.srcObject = stream;

          $(video).attr('autoplay', true);
          $(video).attr('muted', true);
          $(video).attr('playsinline', true);

          video.play();
        }).catch(function(err) {
          console.log('Something went wrong!');
          console.error(err);
        });

        $('#picture-button').click((event) => {
          event.preventDefault();
          const canvas = $("<canvas>")[0]; 
          
          const context = canvas.getContext('2d');

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

          const data = canvas.toDataURL('image/png');
          $('#picture').attr('src', data);

          $.ajax({
            method: 'POST',
            url: '/add-image',
            data: { uri: data },
            success: (response) => {
              if (response.error) {
                console.log('Error');
                console.error(response.error);
                return;
              }

              console.log('success');
              console.log(response);
              if (response.fileName) {
                $('#filename').text(`Filename is ${response.fileName}`);
              } else {
                $('#filename').test(`Error: ${response.error}`);
              }
            },
            error: (error) => {
              console.log('error');
              console.error(error);
            }
          });
        });
      });
    </script>
  </body>
</html>